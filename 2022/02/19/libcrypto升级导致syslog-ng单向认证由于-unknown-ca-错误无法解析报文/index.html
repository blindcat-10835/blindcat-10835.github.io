<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blindcat-10835.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="问题描述PME版本升级, 更新了libcrypto版本, 导致syslog-ng单向认证无法解析报文, 提示unknown ca报错显示如下  Sep  3 14:09:33 syslog4 syslog-ng[45709]: Syslog connection accepted; fd&#x3D;’5’, client&#x3D;’AF_INET(71.41.5.127:38057)’, local&#x3D;’AF_INE">
<meta property="og:type" content="article">
<meta property="og:title" content="libcrypto升级导致syslog-ng单向认证由于&#39;unknown ca&#39;错误无法解析报文">
<meta property="og:url" content="https://blindcat-10835.github.io/2022/02/19/libcrypto%E5%8D%87%E7%BA%A7%E5%AF%BC%E8%87%B4syslog-ng%E5%8D%95%E5%90%91%E8%AE%A4%E8%AF%81%E7%94%B1%E4%BA%8E-unknown-ca-%E9%94%99%E8%AF%AF%E6%97%A0%E6%B3%95%E8%A7%A3%E6%9E%90%E6%8A%A5%E6%96%87/index.html">
<meta property="og:site_name" content="BlindCat">
<meta property="og:description" content="问题描述PME版本升级, 更新了libcrypto版本, 导致syslog-ng单向认证无法解析报文, 提示unknown ca报错显示如下  Sep  3 14:09:33 syslog4 syslog-ng[45709]: Syslog connection accepted; fd&#x3D;’5’, client&#x3D;’AF_INET(71.41.5.127:38057)’, local&#x3D;’AF_INE">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-02-19T17:21:18.000Z">
<meta property="article:modified_time" content="2026-02-28T01:23:44.315Z">
<meta property="article:author" content="BlindCat">
<meta property="article:tag" content="gdb">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blindcat-10835.github.io/2022/02/19/libcrypto%E5%8D%87%E7%BA%A7%E5%AF%BC%E8%87%B4syslog-ng%E5%8D%95%E5%90%91%E8%AE%A4%E8%AF%81%E7%94%B1%E4%BA%8E-unknown-ca-%E9%94%99%E8%AF%AF%E6%97%A0%E6%B3%95%E8%A7%A3%E6%9E%90%E6%8A%A5%E6%96%87/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://blindcat-10835.github.io/2022/02/19/libcrypto%E5%8D%87%E7%BA%A7%E5%AF%BC%E8%87%B4syslog-ng%E5%8D%95%E5%90%91%E8%AE%A4%E8%AF%81%E7%94%B1%E4%BA%8E-unknown-ca-%E9%94%99%E8%AF%AF%E6%97%A0%E6%B3%95%E8%A7%A3%E6%9E%90%E6%8A%A5%E6%96%87/","path":"2022/02/19/libcrypto升级导致syslog-ng单向认证由于-unknown-ca-错误无法解析报文/","title":"libcrypto升级导致syslog-ng单向认证由于'unknown ca'错误无法解析报文"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>libcrypto升级导致syslog-ng单向认证由于'unknown ca'错误无法解析报文 | BlindCat</title>
  



<link rel="dns-prefetch" href="https://hexo-comment-98qvp2zvi-blindcat-10835.vercel.app/">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">BlindCat</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">时间盲目，人类愚蠢</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-share"><a href="/share/" rel="section"><i class="fas fa-star fa-fw"></i>Share</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">问题描述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%BD%8D%E6%80%9D%E8%B7%AF"><span class="nav-number">1.1.</span> <span class="nav-text">定位思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E7%8E%B0%E9%97%AE%E9%A2%98"><span class="nav-number">1.2.</span> <span class="nav-text">复现问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.2.1.</span> <span class="nav-text">复现步骤</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AE%E5%AE%9A%E9%97%AE%E9%A2%98%E4%BB%A3%E7%A0%81"><span class="nav-number">2.</span> <span class="nav-text">确定问题代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8gdb%E8%B0%83%E8%AF%95"><span class="nav-number">2.1.</span> <span class="nav-text">使用gdb调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tcpdump%E6%8A%93%E5%8C%85"><span class="nav-number">2.2.</span> <span class="nav-text">tcpdump抓包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%98%E6%9B%B4%E4%BB%A3%E7%A0%81%E6%89%93%E5%8D%B0%E8%B0%83%E8%AF%95"><span class="nav-number">2.3.</span> <span class="nav-text">变更代码打印调试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E5%8F%98%E6%9B%B4%E4%BB%A3%E7%A0%81%E8%BF%9B%E8%A1%8C%E6%8E%A7%E5%88%B6"><span class="nav-number">2.3.1.</span> <span class="nav-text">对变更代码进行控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%89%93%E5%8D%B0"><span class="nav-number">2.3.2.</span> <span class="nav-text">添加打印</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E6%AF%94%E6%95%B0%E6%8D%AE"><span class="nav-number">2.3.3.</span> <span class="nav-text">对比数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">2.3.4.</span> <span class="nav-text">代码分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="nav-number">3.</span> <span class="nav-text">问题解决</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%84%E4%BB%B6"><span class="nav-number">3.1.</span> <span class="nav-text">附件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">4.</span> <span class="nav-text">Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">BlindCat</p>
  <div class="site-description" itemprop="description">Tempus edax, homo edacior</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/blindcat-10835" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;blindcat-10835" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blindcat10835@foxmail.com" title="E-Mail → mailto:blindcat10835@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blindcat-10835.github.io/2022/02/19/libcrypto%E5%8D%87%E7%BA%A7%E5%AF%BC%E8%87%B4syslog-ng%E5%8D%95%E5%90%91%E8%AE%A4%E8%AF%81%E7%94%B1%E4%BA%8E-unknown-ca-%E9%94%99%E8%AF%AF%E6%97%A0%E6%B3%95%E8%A7%A3%E6%9E%90%E6%8A%A5%E6%96%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlindCat">
      <meta itemprop="description" content="Tempus edax, homo edacior">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlindCat">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          libcrypto升级导致syslog-ng单向认证由于'unknown ca'错误无法解析报文
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-19 17:21:18" itemprop="dateCreated datePublished" datetime="2022-02-19T17:21:18+00:00">2022-02-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2026-02-28 01:23:44" itemprop="dateModified" datetime="2026-02-28T01:23:44+00:00">2026-02-28</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">工作笔记</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论数: </span>
  
    <a title="waline" href="/2022/02/19/libcrypto%E5%8D%87%E7%BA%A7%E5%AF%BC%E8%87%B4syslog-ng%E5%8D%95%E5%90%91%E8%AE%A4%E8%AF%81%E7%94%B1%E4%BA%8E-unknown-ca-%E9%94%99%E8%AF%AF%E6%97%A0%E6%B3%95%E8%A7%A3%E6%9E%90%E6%8A%A5%E6%96%87/#waline-comments" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" id="/2022/02/19/libcrypto%E5%8D%87%E7%BA%A7%E5%AF%BC%E8%87%B4syslog-ng%E5%8D%95%E5%90%91%E8%AE%A4%E8%AF%81%E7%94%B1%E4%BA%8E-unknown-ca-%E9%94%99%E8%AF%AF%E6%97%A0%E6%B3%95%E8%A7%A3%E6%9E%90%E6%8A%A5%E6%96%87/" data-xid="/2022/02/19/libcrypto%E5%8D%87%E7%BA%A7%E5%AF%BC%E8%87%B4syslog-ng%E5%8D%95%E5%90%91%E8%AE%A4%E8%AF%81%E7%94%B1%E4%BA%8E-unknown-ca-%E9%94%99%E8%AF%AF%E6%97%A0%E6%B3%95%E8%A7%A3%E6%9E%90%E6%8A%A5%E6%96%87/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>17k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>15 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>PME版本升级, 更新了libcrypto版本, 导致syslog-ng单向认证无法解析报文, 提示unknown ca<br>报错显示如下</p>
<blockquote>
<p>Sep  3 14:09:33 syslog4 syslog-ng[45709]: Syslog connection accepted; fd=’5’, client=’AF_INET(71.41.5.127:38057)’, local=’AF_INET(0.0.0.0:2460)’<br>Sep  3 14:09:33 syslog4 syslog-ng[45709]: SSL error while reading stream; tls_error=’SSL routines:ssl3_read_bytes:tlsv1 alert unknown ca’, location=’/etc/syslog-ng/syslog-ng.conf:254:9’<br>Sep  3 14:09:33 syslog4 syslog-ng[45709]: I/O error occurred while reading; fd=’5’, error=’Connection reset by peer (104)’<br>Sep  3 14:09:33 syslog4 syslog-ng[45709]: Syslog connection closed; fd=’5’, client=’AF_INET(71.41.5.127:38057)’, local=’AF_INET(0.0.0.0:2460)’</p>
</blockquote>
<h3 id="定位思路"><a href="#定位思路" class="headerlink" title="定位思路"></a>定位思路</h3><ol>
<li>先尝试复现问题</li>
<li>二分定位确定问题代码<ol>
<li>通过<code>git bisect -&gt; 编译libcrypto -&gt; 使用此so，替换syslog服务器使用文件 -&gt; 验证问题是否存在 -&gt; git bisect</code></li>
</ol>
</li>
<li>对变更代码加日志, 查看二者流程差异</li>
<li>客户端gdb调试syslog-ng, 查看报错点, 以及是如何调用openssl的libctypto的</li>
<li>客户端上tcpdump抓包, 对比正误情况下的报文</li>
</ol>
<h3 id="复现问题"><a href="#复现问题" class="headerlink" title="复现问题"></a>复现问题</h3><p>syslog服务器<code>71.47.142.13</code></p>
<p>配置生效重启syslog服务<code>killall /sbin/syslog-ng; /sbin/syslog-ng -f /etc/syslog-ng/syslog-ng.conf</code></p>
<p>客户端 <code>71.41.5.127</code></p>
<p><code>killall /usr/sbin/syslog-ng;/usr/sbin/syslog-ng -f /etc/syslog-ng/syslog-ng.conf -p /var/run/syslogd.pid -F -R /opt/pme/pram/syslog-ng.persist</code></p>
<h4 id="复现步骤"><a href="#复现步骤" class="headerlink" title="复现步骤"></a>复现步骤</h4><ol>
<li>配置好syslog和客户端</li>
<li>在客户端上使用旧版本libcrypto, 通过单向认证发送syslog报文</li>
<li>在syslog服务器上<code>tail -f /var/log/RemoteSyslog/messages</code> 以及 <code>tail -f /var/log/RemoteSyslog/syslog.log</code>查看产生的日志</li>
<li>syslog.log收到如下日志, 表示配置正确, 发送成功<blockquote>
<p>Sep  3 10:51:55 huawei127 &lt;134&gt;Sep  3 10:54:40 huawei127 sensor_alarm:  server 2 test: The receipt of this message confirms that Syslog is configured correctly<br>Sep  3 10:51:55 huawei127 &lt;174&gt;Sep  3 10:54:40 huawei127 sensor_alarm:  2021-09-03 10:54:40 WEB,<a href="mailto:&#65;&#x64;&#109;&#x69;&#110;&#105;&#x73;&#116;&#x72;&#97;&#116;&#111;&#x72;&#64;&#55;&#x35;&#x2e;&#x32;&#53;&#x35;&#46;&#51;&#x30;&#46;&#x35;&#x39;">&#65;&#x64;&#109;&#x69;&#110;&#105;&#x73;&#116;&#x72;&#97;&#116;&#111;&#x72;&#64;&#55;&#x35;&#x2e;&#x32;&#53;&#x35;&#46;&#51;&#x30;&#46;&#x35;&#x39;</a>,sensor_alarm,Set remote syslog dest2 test successfully</p>
</blockquote>
</li>
<li>在客户端替换新版本libcrypto, 重启syslog服务<code>killall /usr/sbin/syslog-ng;/usr/sbin/syslog-ng -f /etc/syslog-ng/syslog-ng.conf -p /var/run/syslogd.pid -F -R /opt/pme/pram/syslog-ng.persist</code>, 发送单向认证报文, 有如下报错<blockquote>
<p>Sep  3 14:09:33 syslog4 syslog-ng[45709]: Syslog connection accepted; fd=’5’, client=’AF_INET(71.41.5.127:38057)’, local=’AF_INET(0.0.0.0:2460)’<br>Sep  3 14:09:33 syslog4 syslog-ng[45709]: SSL error while reading stream; tls_error=’SSL routines:ssl3_read_bytes:tlsv1 alert unknown ca’, location=’/etc/syslog-ng/syslog-ng.conf:254:9’<br>Sep  3 14:09:33 syslog4 syslog-ng[45709]: I/O error occurred while reading; fd=’5’, error=’Connection reset by peer (104)’<br>Sep  3 14:09:33 syslog4 syslog-ng[45709]: Syslog connection closed; fd=’5’, client=’AF_INET(71.41.5.127:38057)’, local=’AF_INET(0.0.0.0:2460)’</p>
</blockquote>
</li>
</ol>
<h2 id="确定问题代码"><a href="#确定问题代码" class="headerlink" title="确定问题代码"></a>确定问题代码</h2><p>libcrypto版本更新代码不多，<br>通过二分定位<code>git bisect -&gt; 编译libcrypto -&gt; 使用此so，替换syslog服务器使用文件 -&gt; 验证问题是否存在 -&gt; git bisect</code>，确定问题结点来自<code>openssl</code>的<code>e2590c3a162eb118c36b09c2168164283aa099b4</code></p>
<blockquote>
<p>commit e2590c3a162eb118c36b09c2168164283aa099b4 (syslog)<br>Author: Dr. David von Oheimb <a href="mailto:&#68;&#97;&#118;&#x69;&#x64;&#x2e;&#x76;&#111;&#x6e;&#x2e;&#x4f;&#104;&#x65;&#x69;&#109;&#x62;&#64;&#115;&#x69;&#x65;&#109;&#101;&#110;&#x73;&#46;&#x63;&#111;&#109;">&#68;&#97;&#118;&#x69;&#x64;&#x2e;&#x76;&#111;&#x6e;&#x2e;&#x4f;&#104;&#x65;&#x69;&#109;&#x62;&#64;&#115;&#x69;&#x65;&#109;&#101;&#110;&#x73;&#46;&#x63;&#111;&#109;</a><br>Date:   Tue Dec 24 11:25:15 2019 +0100</p>
<p>Fix issue 1418 by moving check of KU_KEY_CERT_SIGN and weakening check_issued()</p>
<p>Move check that cert signing is allowed from x509v3_cache_extensions() to<br>where it belongs: internal_verify(), generalize it for proxy cert signing.<br>Correct and simplify check_issued(), now checking self-issued (not: self-signed).<br>Add test case to 25-test_verify.t that demonstrates successful fix.</p>
<p>As prerequisites, this adds the static function check_sig_alg_match()<br>and the internal functions x509_likely_issued() and x509_signing_allowed().</p>
<p>This is a backport of the core of PR #10587.<br>Fixes #1418</p>
<p>Reviewed-by: Tomas Mraz <a href="mailto:&#x74;&#109;&#114;&#97;&#x7a;&#64;&#102;&#101;&#x64;&#x6f;&#114;&#x61;&#112;&#x72;&#111;&#106;&#101;&#x63;&#116;&#46;&#111;&#114;&#x67;">&#x74;&#109;&#114;&#97;&#x7a;&#64;&#102;&#101;&#x64;&#x6f;&#114;&#x61;&#112;&#x72;&#111;&#106;&#101;&#x63;&#116;&#46;&#111;&#114;&#x67;</a><br>(Merged from <a target="_blank" rel="noopener" href="https://github.com/openssl/openssl/pull/12357">https://github.com/openssl/openssl/pull/12357</a>)</p>
</blockquote>
<p>该结点修改代码不多.</p>
<h3 id="使用gdb调试"><a href="#使用gdb调试" class="headerlink" title="使用gdb调试"></a>使用gdb调试</h3><p>断点挂上了,但没有停住, syslog-ng没有调试信息, 此尝试失败</p>
<h3 id="tcpdump抓包"><a href="#tcpdump抓包" class="headerlink" title="tcpdump抓包"></a>tcpdump抓包</h3><p><code>./tcpdump_arm32 host 71.47.142.13 -w /data/tcp_suc</code></p>
<p>对比报文, 发现</p>
<p>成功</p>
<blockquote>
<p>1 0.0 71.41.5.127 71.47.142.13 TLSv1.3 Client Hello<br>2 0.0 71.47.142.13 71.41.5.127 TCP 2460 → 46157 [ACK] Seq=1 Ack=294 Win=501 Len=0<br>3 0.0 71.47.142.13 71.41.5.127 TLSv1.3 Server Hello, Change Cipher Spec, Application Data, Application Data, Application Data<br>4 0.0 71.41.5.127 71.47.142.13 TCP 46157 → 2460 [ACK] Seq=294 Ack=1461 Win=502 Len=0<br>5 0.0 71.47.142.13 71.41.5.127 TLSv1.3 Application Data<br>6 0.0 71.41.5.127 71.47.142.13 TCP 46157 → 2460 [ACK] Seq=294 Ack=1480 Win=502 Len=0<br>7 0.3 71.41.5.127 71.47.142.13 TLSv1.3 Change Cipher Spec, Application Data</p>
</blockquote>
<p>失败</p>
<blockquote>
<p>4 0.0 71.41.5.127 71.47.142.13 TLSv1.3 Client Hello<br>5 0.0 71.47.142.13 71.41.5.127 TCP 2460 → 37895 [ACK] Seq=1 Ack=294 Win=64128 Len=0<br>6 0.0 71.47.142.13 71.41.5.127 TLSv1.3 Server Hello, Change Cipher Spec, Application Data, Application Data, Application Data<br>7 0.0 71.41.5.127 71.47.142.13 TCP 37895 → 2460 [ACK] Seq=294 Ack=1461 Win=32128 Len=0<br>8 0.0 71.47.142.13 71.41.5.127 TLSv1.3 Application Data<br>9 0.0 71.41.5.127 71.47.142.13 TCP 37895 → 2460 [ACK] Seq=294 Ack=1480 Win=32128 Len=0<br>10 0.0 71.41.5.127 71.47.142.13 TLSv1.3 Alert (Level: Fatal, Description: Unknown CA)</p>
</blockquote>
<p>也即, 客户端对服务器的证书校验没有通过.</p>
<h3 id="变更代码打印调试"><a href="#变更代码打印调试" class="headerlink" title="变更代码打印调试"></a>变更代码打印调试</h3><ol>
<li>二分确认问题点: 变更代码较少, 可以很快确定</li>
<li>编译</li>
<li>对比成败问题点数据</li>
</ol>
<h4 id="对变更代码进行控制"><a href="#对变更代码进行控制" class="headerlink" title="对变更代码进行控制"></a>对变更代码进行控制</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先把新旧代码放在一起</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> my_test_xxx</span></span><br><span class="line"><span class="comment">// new version code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// old version code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">// 然后逐步放开代码, 找到错误代码</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h4 id="添加打印"><a href="#添加打印" class="headerlink" title="添加打印"></a>添加打印</h4><p>不知道printf和log被重定向到哪里去了, 直接使用echo打印到文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> cmd[<span class="number">1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="built_in">snprintf</span>(cmd, <span class="keyword">sizeof</span>(cmd) - <span class="number">1</span>, <span class="string">&quot;echo &#x27;(!ku_reject(subject, KU_KEY_CERT_SIGN)) != (ret == X509_V_OK)&#x27; &gt;&gt; /tmp/log&quot;</span>);</span><br><span class="line">system(cmd);</span><br><span class="line"><span class="built_in">memset</span>(cmd, <span class="number">0</span>, <span class="keyword">sizeof</span>(cmd));</span><br></pre></td></tr></table></figure>

<h4 id="对比数据"><a href="#对比数据" class="headerlink" title="对比数据"></a>对比数据</h4><p>旧版本日志</p>
<blockquote>
<p>begin:—————–</p>
<p>!ku_reject(x, KU_KEY_CERT_SIGN)=0<br>(!ku_reject(subject, KU_KEY_CERT_SIGN)) != (ret == X509_V_OK)<br>ret=0<br>!ku_reject(subject, KU_KEY_CERT_SIGN)=0<br>check_sig_alg_match(X509_get0_pubkey(x), x) == X509_V_OK = 1</p>
<p>X509_check_akid(x, x-&gt;akid) =0</p>
<p>x-&gt;sha1_hash=043E21AC3520878795F3AA60CCAF2D58D72A31EF</p>
<p>else flag</p>
<p>end:—————–</p>
<p>begin:—————–</p>
<p>!ku_reject(x, KU_KEY_CERT_SIGN)=1<br>check_sig_alg_match(X509_get0_pubkey(x), x) == X509_V_OK = 1</p>
<p>X509_check_akid(x, x-&gt;akid) =0</p>
<p>x-&gt;sha1_hash=AF35EF3490C5965D3FF4179A9BDA53F4F10B12DF</p>
<p>suc flag</p>
<p>end:—————–</p>
</blockquote>
<p>新版本日志</p>
<blockquote>
<p>begin:—————–</p>
<p>!ku_reject(x, KU_KEY_CERT_SIGN)=0<br>(!ku_reject(subject, KU_KEY_CERT_SIGN)) != (ret == X509_V_OK)<br>ret=0<br>!ku_reject(subject, KU_KEY_CERT_SIGN)=0<br>check_sig_alg_match(X509_get0_pubkey(x), x) == X509_V_OK = 1</p>
<p>X509_check_akid(x, x-&gt;akid) =0</p>
<p>x-&gt;sha1_hash=043E21AC3520878795F3AA60CCAF2D58D72A31EF</p>
<p>(!ku_reject(subject, KU_KEY_CERT_SIGN)) != (ret == X509_V_OK)<br>ret=0<br>!ku_reject(subject, KU_KEY_CERT_SIGN)=0<br>fail flag</p>
<p>end:—————–</p>
<p>begin:—————–</p>
<p>!ku_reject(x, KU_KEY_CERT_SIGN)=1<br>check_sig_alg_match(X509_get0_pubkey(x), x) == X509_V_OK = 1</p>
<p>X509_check_akid(x, x-&gt;akid) =0</p>
<p>x-&gt;sha1_hash=AF35EF3490C5965D3FF4179A9BDA53F4F10B12DF</p>
<p>fail flag</p>
<p>end:—————–</p>
</blockquote>
<p>通过调试数据确定问题出现在<code>crypto/x509v3/v3_purp.c:586</code>条件判断处</p>
<p>新版本判断条件由<code>!ku_reject(x, KU_KEY_CERT_SIGN)</code> 变为 <code>check_sig_alg_match(X509_get0_pubkey(x), x) == X509_V_OK)</code>,</p>
<p>出错时, 根据打印的证书sha值, 也即win下打开证书查看的<code>指纹</code></p>
<p>可以看到, <code>server.csr</code>在新版本走if分支, 而旧版本走else分支, 而<code>ca.csr</code>则分支一致, 说明问题出在<code>server.csr</code>的校验上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">snprintf</span>(cmd, <span class="keyword">sizeof</span>(cmd) - <span class="number">1</span>, <span class="string">&quot;echo &#x27;x-&gt;sha1_hash=%s\n&#x27; &gt;&gt; /tmp/log&quot;</span>, consumer_number);</span><br><span class="line">        system(cmd);</span><br><span class="line">        <span class="built_in">memset</span>(cmd, <span class="number">0</span>, <span class="keyword">sizeof</span>(cmd));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 1</span></span><br><span class="line">        <span class="keyword">if</span> (X509_check_akid(x, x-&gt;akid) == X509_V_OK <span class="comment">/* SKID matches AKID */</span></span><br><span class="line">                <span class="comment">/* .. and the signature alg matches the PUBKEY alg: */</span></span><br><span class="line">                &amp;&amp; check_sig_alg_match(X509_get0_pubkey(x), x) == X509_V_OK) <span class="comment">// 新版本代码</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">memset</span>(cmd, <span class="number">0</span>, <span class="keyword">sizeof</span>(cmd));</span><br><span class="line">            <span class="built_in">snprintf</span>(cmd, <span class="keyword">sizeof</span>(cmd) - <span class="number">1</span>, <span class="string">&quot;echo &#x27;fail flag\n&#x27; &gt;&gt; /tmp/log&quot;</span>);</span><br><span class="line">            system(cmd);</span><br><span class="line">            x-&gt;ex_flags |= EXFLAG_SS; <span class="comment">/* indicate self-signed */</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="keyword">if</span> (X509_check_akid(x, x-&gt;akid) == X509_V_OK &amp;&amp;</span><br><span class="line">            !ku_reject(x, KU_KEY_CERT_SIGN))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">snprintf</span>(cmd, <span class="keyword">sizeof</span>(cmd) - <span class="number">1</span>, <span class="string">&quot;echo &#x27;suc flag\n&#x27; &gt;&gt; /tmp/log&quot;</span>);</span><br><span class="line">            system(cmd);</span><br><span class="line">            <span class="built_in">memset</span>(cmd, <span class="number">0</span>, <span class="keyword">sizeof</span>(cmd));</span><br><span class="line">            x-&gt;ex_flags |= EXFLAG_SS;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memset</span>(cmd, <span class="number">0</span>, <span class="keyword">sizeof</span>(cmd));</span><br><span class="line">            <span class="built_in">snprintf</span>(cmd, <span class="keyword">sizeof</span>(cmd) - <span class="number">1</span>, <span class="string">&quot;echo &#x27;else flag\n&#x27; &gt;&gt; /tmp/log&quot;</span>);</span><br><span class="line">            system(cmd);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>ku_reject</code>定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ku_reject(x,usage) (((x)-&gt;ex_flags &amp; EXFLAG_KUSAGE) &amp;&amp; !((x)-&gt;ex_kusage &amp; (usage)))</span></span><br><span class="line"><span class="comment">//Expands to:</span></span><br><span class="line"></span><br><span class="line">(((x)-&gt;ex_flags &amp; EXFLAG_KUSAGE) &amp;&amp; !((x)-&gt;ex_kusage &amp; (<span class="number">0x0004</span>)))</span><br></pre></td></tr></table></figure>

<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><p>解决问题后回头看, 这里的讨论或许能解释为何要更改这个判断条件, 但当时既然已经有很有限的代码, 就直接顺着代码分析下去, 没有仔细看这个帖子</p>
<p><a target="_blank" rel="noopener" href="https://github.com/openssl/openssl/pull/12357">Improve key usage checks in internal_verify() and backport fix of issue 1418 to v1.1.1 by DDvO · Pull Request #12357 · openssl/openssl</a>  </p>
<p>syslog-ng支持使用libcrypto进行单向和双向认证, 单向认证时, 客户端使用本地的ca.csr校验服务器发送过来的server.csr.</p>
<p>这里出错时, 将server.csr本不该加上的<code>EXFLAG_SS</code>加上了, 导致失败</p>
<p>这个标志, 表明证书是<code>self-signed</code>.</p>
<p>从代码上看,<code>self-signed</code>证书的条件在于</p>
<ul>
<li><p>首先得是<code>self-issued</code>, 也即满足<code>!X509_NAME_cmp(X509_get_subject_name(x), X509_get_issuer_name(x))</code></p>
<ul>
<li>这里的subject即使用者, issuer即签发者</li>
</ul>
</li>
<li><p>而后,旧版本, 满足<code>!ku_reject(x, KU_KEY_CERT_SIGN)</code></p>
<ul>
<li><p>也即通过<code>key_usage</code>判断;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ku_reject(x,usage) (((x)-&gt;ex_flags &amp; EXFLAG_KUSAGE) &amp;&amp; !((x)-&gt;ex_kusage &amp; (usage)))</span></span><br><span class="line"><span class="comment">//Expands to:</span></span><br><span class="line"></span><br><span class="line">(((x)-&gt;ex_flags &amp; EXFLAG_KUSAGE) &amp;&amp; !((x)-&gt;ex_kusage &amp; (<span class="number">0x0004</span>)))</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里的依据, 可能是<a target="_blank" rel="noopener" href="https://superuser.com/questions/738612/openssl-ca-keyusage-extension">ssl - OpenSSL CA keyUsage extension - Super User</a>所讨论的<code>Self-signed CA</code>的keyUsage的差异</p>
</li>
</ul>
</li>
<li><p>新版本, 判定条件改为<code>check_sig_alg_match(X509_get0_pubkey(x), x) == X509_V_OK)</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Check that issuer public key algorithm matches subject signature algorithm */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">check_sig_alg_match</span><span class="params">(<span class="keyword">const</span> EVP_PKEY *pkey, <span class="keyword">const</span> X509 *subject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pkey_nid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pkey == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> X509_V_ERR_NO_ISSUER_PUBLIC_KEY;</span><br><span class="line">    <span class="keyword">if</span> (OBJ_find_sigid_algs(OBJ_obj2nid(subject-&gt;cert_info.signature.algorithm),</span><br><span class="line">                            <span class="literal">NULL</span>, &amp;pkey_nid) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> X509_V_ERR_UNSUPPORTED_SIGNATURE_ALGORITHM;</span><br><span class="line">    <span class="keyword">if</span> (EVP_PKEY_type(pkey_nid) != EVP_PKEY_base_id(pkey))</span><br><span class="line">        <span class="keyword">return</span> X509_V_ERR_SIGNATURE_ALGORITHM_MISMATCH;</span><br><span class="line">    <span class="keyword">return</span> X509_V_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看出, 和之前毫无关系.</li>
</ul>
</li>
<li><p>不论如何, 要构造出可用的<code>server.csr</code>, 需要满足以下条件</p>
<ul>
<li>self-issued, 即证书颁发者字段和使用者字段一致</li>
<li>SKID(<code>subject key identifier</code>)和AKID(<code>authority key identifier</code>)不一致, 或者签名算法和公钥算法不一致</li>
</ul>
</li>
<li><p>这里可以很容易构造出SKID和AKID不一致的场景</p>
</li>
</ul>
<h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>修改证书生成脚本，重新生成证书, 其中ca.csr不变, server.csr中使SKID和AKID不一致.</p>
<p>至此, 问题得到解决</p>
<h3 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h3><ul>
<li>重启syslog <code>/usr/sbin/syslog-ng -f /etc/syslog-ng/syslog-ng.conf -p /var/run/syslogd.pid -F -R /opt/pme/pram/syslog-ng.persist -dev</code></li>
<li>报错日志</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[2021-10-12T11:22:38.956853] Syslog connection failed; fd=&#x27;19&#x27;, server=&#x27;AF_INET(71.47.142.13:2440)&#x27;, error=&#x27;Connection refused (111)&#x27;, time_reopen=&#x27;10&#x27;</span><br><span class="line">[2021-10-12T11:22:45.778034] Syslog connection accepted; fd=&#x27;13&#x27;, client=&#x27;AF_UNIX(anonymous)&#x27;, local=&#x27;AF_UNIX(/dev/log)&#x27;</span><br><span class="line">[2021-10-12T11:22:45.805019] Incoming log entry; line=&#x27;&lt;174&gt;Oct 12 11:22:45 user: 2021-10-12 11:22:45 WEB,Administrator@75.255.28.83,User,Administrator(75.255.28.83) login successfully over the WebUI&#x27;</span><br><span class="line">[2021-10-12T11:22:45.818988] Incoming log entry; line=&#x27;&lt;86&gt;Oct 12 11:22:45 user: Administrator(75.255.28.83) login successfully over the WebUI&#x27;</span><br><span class="line">[2021-10-12T11:22:45.824206] Initializing destination file writer; template=&#x27;/var/log/pme/security_log&#x27;, filename=&#x27;/var/log/pme/security_log&#x27;</span><br><span class="line">[2021-10-12T11:22:45.826221] Outgoing message; message=&#x27;2021-10-12T11:22:45+08:00 cxtkVeyDTL user: Administrator(75.255.28.83) login successfully over the WebUI\x0a&#x27;</span><br><span class="line">[2021-10-12T11:22:45.846269] Outgoing message; message=&#x27;&lt;86&gt; iBMC  test: 2021-10-12T11:22:45+08:00 cxtkVeyDTL user: Administrator(75.255.28.83) login successfully over the WebUI\x0a&#x27;</span><br><span class="line">[2021-10-12T11:22:45.870464] Outgoing message; message=&#x27;&lt;174&gt; iBMC  test: 2021-10-12 11:22:45 WEB,Administrator@75.255.28.83,User,Administrator(75.255.28.83) login successfully over the WebUI\x0a&#x27;</span><br><span class="line">[2021-10-12T11:22:45.896590] Certificate validation failed; subject=&#x27;CN=syslog4.it.bmctest.com, OU=it, O=huawei, L=hz, ST=zj, C=cn&#x27;, issuer=&#x27;CN=syslog4.it.bmctest.com, OU=it, O=huawei, L=hz, ST=zj, C=cn&#x27;, error=&#x27;self signed certificate&#x27;, depth=&#x27;0&#x27;</span><br><span class="line">[2021-10-12T11:22:45.914936] SSL error while writing stream; tls_error=&#x27;SSL routines:tls_process_server_certificate:certificate verify failed&#x27;, location=&#x27;/etc/syslog-ng/remotelog.conf:20:119&#x27;</span><br><span class="line">[2021-10-12T11:22:45.915711] I/O error occurred while writing; fd=&#x27;16&#x27;, error=&#x27;Broken pipe (32)&#x27;</span><br><span class="line">[2021-10-12T11:22:45.926733] Syslog connection broken; fd=&#x27;16&#x27;, server=&#x27;AF_INET(71.47.142.13:2460)&#x27;, time_reopen=&#x27;10&#x27;</span><br><span class="line">[2021-10-12T11:22:45.935473] Certificate validation failed; subject=&#x27;CN=syslog4.it.bmctest.com, OU=it, O=huawei, L=hz, ST=zj, C=cn&#x27;, issuer=&#x27;CN=syslog4.it.bmctest.com, OU=it, O=huawei, L=hz, ST=zj, C=cn&#x27;, error=&#x27;self signed certificate&#x27;, depth=&#x27;0&#x27;</span><br><span class="line">[2021-10-12T11:22:45.941132] SSL error while writing stream; tls_error=&#x27;SSL routines:tls_process_server_certificate:certificate verify failed&#x27;, location=&#x27;/etc/syslog-ng/remotelog.conf:19:115&#x27;</span><br><span class="line">[2021-10-12T11:22:45.944786] I/O error occurred while writing; fd=&#x27;15&#x27;, error=&#x27;Broken pipe (32)&#x27;</span><br><span class="line">[2021-10-12T11:22:45.949132] Syslog connection broken; fd=&#x27;15&#x27;, server=&#x27;AF_INET(71.47.142.13:2460)&#x27;, time_reopen=&#x27;10&#x27;</span><br><span class="line">[2021-10-12T11:22:48.965869] Syslog connection failed; fd=&#x27;15&#x27;, server=&#x27;AF_INET(71.47.142.13:2440)&#x27;, error=&#x27;Connection refused (111)&#x27;, time_reopen=&#x27;10&#x27;</span><br><span class="line">[2021-10-12T11:22:55.935707] Syslog connection established; fd=&#x27;15&#x27;, server=&#x27;AF_INET(71.47.142.13:2460)&#x27;, local=&#x27;AF_INET(0.0.0.0:0)&#x27;</span><br><span class="line">[2021-10-12T11:22:55.956495] Syslog connection established; fd=&#x27;16&#x27;, server=&#x27;AF_INET(71.47.142.13:2460)&#x27;, local=&#x27;AF_INET(0.0.0.0:0)&#x27;</span><br><span class="line">[2021-10-12T11:22:58.974612] Syslog connection failed; fd=&#x27;19&#x27;, server=&#x27;AF_INET(71.47.142.13:2440)&#x27;, error=&#x27;Connection refused (111)&#x27;, time_reopen=&#x27;10&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>gdb查看调用栈</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">0</span>  tls_session_verify (self=<span class="number">0x101e348</span>, ok=<span class="number">0</span>, ctx=<span class="number">0xb5b489a8</span>) at lib/tlscontext.c:<span class="number">186</span></span><br><span class="line">#1  0xb6f271ec in tls_session_verify_callback (ok=0, ctx=0xb5b489a8) at lib/tlscontext.c:264</span><br><span class="line">#<span class="number">2</span>  <span class="number">0xb6c6ee6c</span> in ?? () from /usr/lib/libcrypto.so<span class="number">.1</span><span class="number">.1</span></span><br><span class="line">#3  0xb6c6fed8 in X509_verify_cert () from /usr/lib/libcrypto.so.1.1</span><br><span class="line">#4  0xb6d1eb44 in ssl_verify_cert_chain () from /usr/lib/libssl.so.1.1</span><br><span class="line">#5  0xb6d4176c in tls_process_server_certificate () from /usr/lib/libssl.so.1.1</span><br><span class="line">#6  0xb6d43ccc in ossl_statem_client_process_message () from /usr/lib/libssl.so.1.1</span><br><span class="line">#7  0xb6d3d900 in state_machine () from /usr/lib/libssl.so.1.1</span><br><span class="line">#8  0xb6d138ac in ssl3_write_bytes () from /usr/lib/libssl.so.1.1</span><br><span class="line">#9  0xb6d1b220 in ssl3_write () from /usr/lib/libssl.so.1.1</span><br><span class="line">#10 0xb6d26bc8 in ssl_write_internal () from /usr/lib/libssl.so.1.1</span><br><span class="line">#11 0xb6d26d90 in SSL_write () from /usr/lib/libssl.so.1.1</span><br><span class="line">#12 0xb6f27e48 in log_transport_tls_write_method (s=0x101bfc8, buf=&lt;optimized out&gt;, buflen=&lt;optimized out&gt;) at lib/transport/transport-tls.c:178</span><br><span class="line">#13 0xb6f39744 in log_transport_write (count=106, buf=&lt;optimized out&gt;, self=&lt;optimized out&gt;) at ./lib/transport/logtransport.h:47</span><br><span class="line">#<span class="number">14</span> log_proto_text_client_flush (s=<span class="number">0x101fed0</span>) at lib/logproto/logproto-text-client.c:<span class="number">90</span></span><br><span class="line">#15 0xb6f19ac0 in log_proto_client_process_in (s=&lt;optimized out&gt;) at lib/logproto/logproto-client.h:163</span><br><span class="line">#<span class="number">16</span> log_writer_process_in (self=<span class="number">0xfdb2c0</span>) at lib/logwriter.c:<span class="number">1318</span></span><br><span class="line">#<span class="number">17</span> log_writer_work_perform (s=<span class="number">0xfdb2c0</span>, cond=&lt;optimized out&gt;) at lib/logwriter.c:<span class="number">204</span></span><br><span class="line">#<span class="number">18</span> <span class="number">0xb6f1c070</span> in _work (self=&lt;optimized out&gt;) at lib/mainloop-io-worker.c:<span class="number">69</span></span><br><span class="line">#19 0xb6f65b44 in iv_work_thread_got_event (_thr=0x101dc90) at iv_work.c:106</span><br><span class="line">#<span class="number">20</span> <span class="number">0xb6f64404</span> in __iv_event_run_pending_events (_st=<span class="number">0xb5b23860</span>) at iv_event.c:<span class="number">56</span></span><br><span class="line">#21 0xb6f69824 in iv_fd_epoll_timerfd_poll (st=0xb5b23860, active=0xb64fd3d4, abs=&lt;optimized out&gt;) at iv_fd_epoll.c:484</span><br><span class="line">#22 0xb6f667dc in iv_fd_poll_and_run (st=st@entry=0xb5b23860, abs=&lt;optimized out&gt;) at iv_fd.c:206</span><br><span class="line">#23 0xb6f67884 in iv_main () at iv_main_posix.c:112</span><br><span class="line">#24 0xb6f6594c in iv_work_thread (_thr=0x101dc90) at iv_work.c:185</span><br><span class="line">#25 0xb6f68998 in iv_thread_handler (_thr=0xfe0940) at iv_thread_posix.c:112</span><br><span class="line">#<span class="number">26</span> <span class="number">0xb6a53374</span> in ?? () from /lib/libpthread.so<span class="number">.0</span></span><br><span class="line">#<span class="number">27</span> <span class="number">0xb69da9e0</span> in ?? () from /lib/libc.so<span class="number">.6</span></span><br><span class="line">Backtrace stopped: <span class="function">previous frame identical to <span class="keyword">this</span> <span class="title">frame</span> <span class="params">(corrupt <span class="built_in">stack</span>?)</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>服务器日志</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># server message 日志</span></span><br><span class="line">$ ssh root@<span class="number">71.47</span><span class="number">.142</span><span class="number">.13</span></span><br><span class="line">Password:</span><br><span class="line">Last login: Tue Oct <span class="number">12</span> <span class="number">14</span>:<span class="number">17</span>:<span class="number">40</span> <span class="number">2021</span> from <span class="number">75.255</span><span class="number">.28</span><span class="number">.83</span></span><br><span class="line">Have a lot of fun...</span><br><span class="line">localhost:~ <span class="meta"># tail -f /var/log/RemoteSyslog/messages</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Oct 12 15:19:29 localhost syslog-ng[2835]: Syslog connection accepted; fd=&#x27;26&#x27;, client=&#x27;AF_INET(71.56.25.9:35867)&#x27;, local=&#x27;AF_INET(0.0.0.0:2460)&#x27;</span><br><span class="line">Oct 12 15:19:29 localhost syslog-ng[2835]: Syslog connection accepted; fd=&#x27;28&#x27;, client=&#x27;AF_INET(71.56.25.9:34934)&#x27;, local=&#x27;AF_INET(0.0.0.0:2460)&#x27;</span><br><span class="line">Oct 12 15:19:29 localhost syslog-ng[2835]: SSL error while reading stream; tls_error=&#x27;SSL routines:ssl3_read_bytes:tlsv1 alert unknown ca&#x27;, location=&#x27;/etc/syslog-ng/syslog-ng.conf:254:9&#x27;</span><br><span class="line">Oct 12 15:19:29 localhost syslog-ng[2835]: I/O error occurred while reading; fd=&#x27;26&#x27;, error=&#x27;Connection reset by peer (104)&#x27;</span><br><span class="line">Oct 12 15:19:29 localhost syslog-ng[2835]: Syslog connection closed; fd=&#x27;26&#x27;, client=&#x27;AF_INET(71.56.25.9:35867)&#x27;, local=&#x27;AF_INET(0.0.0.0:2460)&#x27;</span><br><span class="line">Oct 12 15:19:29 localhost syslog-ng[2835]: SSL error while reading stream; tls_error=&#x27;SSL routines:ssl3_read_bytes:tlsv1 alert unknown ca&#x27;, location=&#x27;/etc/syslog-ng/syslog-ng.conf:254:9&#x27;</span><br><span class="line">Oct 12 15:19:29 localhost syslog-ng[2835]: I/O error occurred while reading; fd=&#x27;28&#x27;, error=&#x27;Connection reset by peer (104)&#x27;</span><br><span class="line">Oct 12 15:19:29 localhost syslog-ng[2835]: Syslog connection closed; fd=&#x27;28&#x27;, client=&#x27;AF_INET(71.56.25.9:34934)&#x27;, local=&#x27;AF_INET(0.0.0.0:2460)&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://help.hcltechsw.com/domino/11.0.0/conf_keyusageextensionsandextendedkeyusage_r.html">Key usage extensions and extended key usage</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/openssl/openssl/pull/12357">Improve key usage checks in internal_verify() and backport fix of issue 1418 to v1.1.1 by DDvO · Pull Request #12357 · openssl/openssl</a>  </p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/10308903/find-if-a-certificate-is-self-signed-or-ca-signed">java - Find if a certificate is self signed or CA signed - Stack Overflow</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/gdb/" rel="tag"># gdb</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/01/24/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="prev" title="设计模式学习笔记">
                  <i class="fa fa-chevron-left"></i> 设计模式学习笔记
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/02/24/%E4%BD%BF%E7%94%A8python2%E5%BA%93paramiko-%E6%A8%A1%E6%8B%9Fssh%E7%99%BB%E5%BD%95%E7%BB%88%E7%AB%AF%EF%BC%8C%E6%A6%82%E7%8E%87%E6%80%A7%E5%87%BA%E7%8E%B0coredump/" rel="next" title="使用python2库 paramiko 模拟ssh登录终端，概率性出现coredump">
                  使用python2库 paramiko 模拟ssh登录终端，概率性出现coredump <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline-comments"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">BlindCat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Symbols count total">43k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">39 mins.</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  




  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





<script class="next-config" data-name="waline" type="application/json">{"lang":null,"enable":true,"serverURL":"https://hexo-comment-98qvp2zvi-blindcat-10835.vercel.app/","placeholder":"Just go go","avatar":"robohash","pageSize":10,"visitor":false,"comment_count":true,"requiredMeta":[],"copyright":true,"allowUploadImage":true,"meta":["nick","mail","link"],"qiniuDebug":false,"qiniuDomain":null,"qiniuTokenUrl":null,"requiredFields":[],"el":"#waline-comments","libUrl":"https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js","path":"/2022/02/19/libcrypto%E5%8D%87%E7%BA%A7%E5%AF%BC%E8%87%B4syslog-ng%E5%8D%95%E5%90%91%E8%AE%A4%E8%AF%81%E7%94%B1%E4%BA%8E-unknown-ca-%E9%94%99%E8%AF%AF%E6%97%A0%E6%B3%95%E8%A7%A3%E6%9E%90%E6%8A%A5%E6%96%87/","login":"","dark":"auto","avatarCDN":"https://seccdn.libravatar.org/avatar/"}</script>
<script>
document.addEventListener('page:loaded', () => {
  if(!CONFIG.waline.allowUploadImage) {
    CONFIG.waline.uploadImage = false;
  }
  else if(CONFIG.waline.qiniuDomain && CONFIG.waline.qiniuTokenUrl) {
    CONFIG.waline.uploadImage = qiniuUploadImage;
  }
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => {
    new Waline(CONFIG.waline);
  });
});
</script>

</body>
</html>
